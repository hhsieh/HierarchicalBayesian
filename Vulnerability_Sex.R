### Hierarchical Bayesian Model##
## Only works for survival data##

## load packages that we'll need
library(lme4)
library(R2jags)
library(mcmcplots)

##data
setwd("/Users/achimnyswallow/Documents/ELME 2014/Bayes/Project")
azya<-read.csv("Megadata_Azya_parasitism_2012_2013.csv")
str(azya)


azya <- azya[1:151,]
y <- azya$survival

treatment <- as.integer(azya$treatment)-1  
ants <- azya$ants
phorids <- azya$phorids
parasitoids <- azya$parasitoids
N.obs.y <- length(y)
trial1 <- azya$trial
trials1 <- unique(trial1)
N.trials1 <- length(trials1)

#z <- as.integer(azya$sex_survivor)-1
#N.obs.z <- length(z)

#trial2 <- azya$trial
#trials2 <- unique(trial2)
#N.trials2 <- length(trials2)
#ants <- azya$ants
#phorids <- azya$phorids
#parasitoids <- azya$parasitoids

## you should recognize this inverse function
invlogit <- function(x){exp(x) / (1 + exp(x))}

## Write JAGS model
sink("HB_azya_surv_sex.txt")
cat("  
    model{
    
    # Priors
    
    mu.beta1 ~ dnorm(0,0.0001)
    sigma.beta1 ~ dnorm(0,0.0001)
    tau.beta1 <- 1/(sigma.beta1*sigma.beta1)

    mu.gamma1 ~ dnorm(0,0.0001)
    sigma.gamma1 ~ dnorm(0,0.0001)
    tau.gamma1 <- 1/(sigma.gamma1*sigma.gamma1)
  
    mu.delta1 ~ dnorm(0,0.0001)
    sigma.delta1 ~ dnorm(0,0.0001)
    tau.delta1 <- 1/(sigma.delta1*sigma.delta1)

    #mu.alpha2 ~ dnorm(0,0.0001)
    #sigma.alpha2 ~ dnorm(0,0.001)
    #tau.alpha2 <- 1/(sigma.alpha2*sigma.alpha2)

    #mu.beta2 ~ dnorm(0,0.0001)
    #sigma.beta2 ~ dnorm(0,0.001)
    #tau.beta2 <- 1/(sigma.beta2*sigma.beta2)

    #mu.gamma2 ~ dnorm(0,0.0001)
    #sigma.gamma2 ~ dnorm(0,0.0001)  
    #tau.gamma2 <- 1/(sigma.gamma2*sigma.gamma2)

    #mu.delta2 ~ dnorm(0,0.0001)
    #sigma.delta2 ~ dnorm(0,0.0001)
    #tau.delta2 <- 1/(sigma.delta2*sigma.delta2)

    ## trial means
    for(i in 1:N.trials1){    
    beta1[i] ~ dnorm(mu.beta1,tau.beta1)
    gamma1[i] ~ dnorm(mu.gamma1,tau.gamma1)
    delta1[i] ~ dnorm(mu.delta1,tau.delta1)
    }

    #for(i in 1:N.trials2){
    #alpha2[i] ~ dnorm(mu.alpha2,tau.alpha2)
    #beta2[i] ~ dnorm(mu.beta2,tau.beta2)
    #gamma2[i] ~ dnorm(mu.gamma2,tau.gamma2)
    #delta2[i] ~ dnorm(mu.delta2,tau.delta2)
    #}


    # Likelihood
    for(i in 1:N.obs.y){
    logit(p1[i]) <- beta1[trial1[i]]*ants[i]+gamma1[trial1[i]]*phorids[i]+delta1[trial1[i]]*parasitoids[i]
    y[i] ~ dbern(p1[i])
    }

    #for(i in 1:N.obs.z){
    #logit(p2[i]) <- alpha2[trial[i]]+beta2[trial[i]]*ants[i]+gamma2[trial[i]]*phorids[i]+delta2[trial[i]]*parasitoids[i]
    #z[i] ~ dbern(p2[i])
    #}
   
    ## Prediction
    beta1.pred ~ dnorm(mu.beta1,tau.beta1)
    gamma1.pred ~ dnorm(mu.gamma1,tau.gamma1)
    delta1.pred ~ dnorm(mu.delta1,tau.delta1)
  
    #alpha2.pred ~ dnorm(mu.alpha2,tau.alpha2)
    #beta2.pred ~ dnorm(mu.beta2,tau.beta2)
    #gamma2.pred ~ dnorm(mu.gamma2,tau.gamma2)
    #delta2.pred ~ dnorm(mu.delta2,tau.delta2)

    for (i in 1:N.obs.y) {
    y.pred[i] <- exp(beta1.pred*ants[i]+gamma1.pred*phorids[i]+delta1.pred*parasitoids[i])/(1+exp(beta1.pred*ants[i]+gamma1.pred*phorids[i]+delta1.pred*parasitoids[1]))
    y.pred2[i] <- exp(mu.beta1*ants[i]+mu.gamma1*phorids[i]+mu.delta1*parasitoids[i])/(1+exp(mu.beta1*ants[i]+mu.gamma1*phorids[i]+mu.delta1*parasitoids[i]))
    }
    
    #for (i in 1:N.obs.z) {
    #z.pred[i] <- exp(alpha2.pred+beta2.pred*ants[i]+gamma2.pred*phorids[i]+delta2.pred*parasitoids[i])/(1+exp(alpha2+beta2.pred*ants[i]+gamma2.pred*phorids[i]+delta2.pred*parasitoids[1]))
    #z.pred2[i] <- exp(mu.alpha2+mu.beta2*ants[i]+mu.gamma2*phorids[i]+mu.delta2*parasitoids[i])/(1+exp(mu.alpha2+mu.beta2*ants[i]+mu.gamma2*phorids[i]+mu.delta2*parasitoids[i]))
    #}

    # derived quantities
    
    mu.diff.surv.parasitoids.ants <- exp(mu.beta1+mu.delta1)/(1+exp(mu.beta1+mu.delta1))-exp(mu.delta1)/(1+exp(mu.delta1))
    mu.diff.surv.parasitoids.phorids <- exp(mu.beta1+mu.gamma1+mu.delta1)/(1+exp(mu.beta1+mu.gamma1+mu.delta1))-exp(mu.delta1)/(1+exp(mu.delta1))
    mu.diff.surv.ants.phorids <- exp(mu.beta1+mu.gamma1+mu.delta1)/(1+exp(mu.beta1+mu.gamma1+mu.delta1))-exp(mu.beta1+mu.delta1)/(1+exp(mu.beta1+mu.delta1))

    #surv.parasitoids <- exp(delta1) / (1+exp(delta1))
    #surv.ants <- exp(beta1+delta1) / (1+exp(beta1+delta1))
    #surv.phorids <- exp(beta1+gamma1+delta1) / (1+exp(beta1+gamma1+delta1))
    #surv.diff.parasitoids.ants <- surv.ants - surv.parasitoids
    #surv.diff.parasitoids.phorids <- surv.phorids - surv.parasitoids
    #surv.diff.ants.phorids <- surv.phorids - surv.ants
    
    #male.natural <- exp(alpha2) / (1+exp(alpha2))
    #male.parasitoids <- exp(alpha2+delta2) / (1+exp(alpha2+delta2))
    #male.ants <- exp(alpha2+delta2+beta2) / (1+exp(alpha2+delta2+beta2))
    #male.phorids <- exp(alpha2+delta2+beta2+gamma2) / (1+exp(alpha2+delta2+beta2+gamma2))
    #male.surv.diff.parasitoids.ants <- male.ants-male.parasitoids
    #male.surv.diff.ants.phorids <- male.phorids-male.ants
    #male.surv.diff.parasitoids.phorids <- male.phorids-male.ants
    #male.surv.diff.parasitoids.natural <-male.natural-male.parasitoids
    
    #per.capita.male.surv.parasitoids <- surv.parasitoids*male.parasitoids/male.natural
    #per.capita.male.surv.ants <- surv.ants*male.ants / male.natural
    #per.capita.male.surv.phorids <- surv.phorids*male.phorids / male.natural
    
    #diff.per.capita.male.surv.parasitoids.ants <- per.capita.male.surv.ants - per.capita.male.surv.parasitoids
    #diff.per.capita.male.surv.parasitoids.phorids <- per.capita.male.surv.phorids - per.capita.male.surv.parasitoids
    #diff.per.capita.male.surv.ants.phorids <- per.capita.male.surv.phorids - per.capita.male.surv.ants
    
    
    
    #per.capita.female.surv.parasitoids <- surv.parasitoids*(1-male.parasitoids)/(1-male.natural)
    #per.capita.female.surv.ants <- surv.ants*(1-male.ants)/(1-male.natural)
    #per.capita.female.surv.phorids <- surv.phorids*(1-male.phorids)/(1-male.natural)
    
    #diff.per.capita.female.surv.parasitoids.ants <- per.capita.female.surv.ants - per.capita.female.surv.parasitoids
    #diff.per.capita.female.surv.parasitoids.phorids <- per.capita.female.surv.ants - per.capita.female.surv.phorids
    #diff.per.capita.female.surv.ants.phorids <- per.capita.female.surv.phorids - per.capita.female.surv.ants
    
    
    }##close model bracket
    ",fill=T) ## close cat
sink()


## bundle data
jag.data <- list(y = y,
               #z = z,
               trial1 = trial1,
               N.trials1 = N.trials1,
               #N.trials2 = N.trials2,
               N.obs.y = N.obs.y,
               #N.obs.z = N.obs.z,
               ants = ants,
               phorids = phorids,
               parasitoids = parasitoids)

## Inits function
inits <- function(){list(#alpha2 = rnorm(N.trials2,0,2),
                       #beta2 = rnorm(N.trials2,0,2),
                       #gamma2 = rnorm(N.trials2,0,2),
                       #delta2 = rnorm(N.trials2,0,2),
                       beta1 = rnorm(N.trials1,0,2),
                       gamma1 = rnorm(N.trials1,0,2),
                       delta1 = rnorm(N.trials1,0,2),
                       #mu.alpha2 = rnorm(1,0,5),
                       #mu.beta2 = rnorm(1,0,5),
                       #mu.gamma2 = rnorm(1,0,5),
                       #mu.delta2 = rnorm(1,0,5),
                       mu.beta1 = rnorm(1,0,5),
                       mu.gamma1 = rnorm(1,0,5),
                       mu.delta1 = rnorm(1,0,5),
                       #sigma.alpha2 = rlnorm(1),
                       #sigma.beta2 = rlnorm(1),
                       #sigma.gamma2 = rlnorm(1),
                       #sigma.delta2 = rlnorm(1),
                       sigma.beta1 = rlnorm(1),
                       sigma.gamma1 = rlnorm(1),
                       sigma.delta1 = rlnorm(1))
                  }

## Params to estimate
parameters <- c("mu.diff.surv.parasitoids.ants",
              "mu.diff.surv.parasitoids.phorids",
              "mu.diff.surv.ants.phorids",
              "mu.beta1",
              "mu.gamma1",
              "mu.delta1",
              "beta1",
              "gamma1",
              "delta1",
              "sigma.beta1",
              "sigma.gamma1",
              "sigma.delta1",
              "y.pred",
              "y.pred2")
              
                          
## MCMC settings
ni <- 10000
nb <- 1000
nt <- 5
nc <- 3

## run JAGS
azya.surv.sex.out <- jags(data = jag.data,inits = inits,parameters.to.save = parameters,model.file = "HB_azya_surv_sex.txt",
                      n.thin = nt,n.chains = nc,n.burnin = nb,n.iter = ni,DIC = T,working.directory = getwd())

mcmcplot(azya.surv.sex.out,c("mu.diff.surv.parasitoids.ants","mu.diff.surv.parasitoids.phorids","mu.diff.surv.ants.phorids","mu.beta1","mu.gamma1","mu.delta1","beta1","gamma1","delta1","sigma.beta1","sigma.gamma1","sigma.delta1"))
         
                             #"mu.alpha2",
                             #"mu.beta2",
                             #"mu.gamma2",
                             #"mu.delta2",
                             #"sigma.alpha2",
                             #"sigma.beta2",
                             #"sigma.gamma2",
                             #"sigma.delta2"


## Plot model predictions
#plot(x.levels,invlogit(cholla.surv.out$BUGSoutput$mean$mu.alpha+cholla.surv.out$BUGSoutput$mean$mu.beta*x.levels),
     type="l",lwd=3,col="tomato",ylim=c(0,1),xlab="log(Volume)",ylab="Probability of survival",cex.lab=1.2)
#lines(x.levels,cholla.surv.out$BUGSoutput$summary[22:(22+(N.x.levels-1)),"2.5%"],type="l",lwd=2,col="grey")
#lines(x.levels,cholla.surv.out$BUGSoutput$summary[22:(22+(N.x.levels-1)),"97.5%"],type="l",lwd=2,col="grey")

#lines(x.levels,cholla.surv.out$BUGSoutput$summary[(22+(N.x.levels)):(22+(N.x.levels)+(N.x.levels-1)),"2.5%"],type="l",lwd=2,lty=2,col="grey")
#lines(x.levels,cholla.surv.out$BUGSoutput$summary[(22+(N.x.levels)):(22+(N.x.levels)+(N.x.levels-1)),"97.5%"],type="l",lwd=2,lty=2,col="grey")

## Here is a prettier way to plot Bernoulli data using binned means
## number of bins you want
#ncuts<-10
## bin your X variable (size)
#chopsize<-cut(log(cholla2$sizet),ncuts)
## get mean size of each bin
#binmean.size<-as.numeric(sapply(split(log(cholla2$sizet),chopsize),mean))
## get mean survival of each bin (could do the same for flowering or any other binomial response)
## in this line, "survival" should be a vector of zeroes and ones
#binmean.surv<-as.numeric(sapply(split(cholla2$Survival_t1,chopsize),mean))
## add bin means to plot
#points(binmean.size, binmean.surv,pch=16,cex=1.2)

#legend("bottomright",legend=c("Mean","CI - Error only","CI - Plot variance"),
       #cex=1.4,lwd=2,col=c("tomato","grey","grey"),lty=c(1,2,1),bty="n")
